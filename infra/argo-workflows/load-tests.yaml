apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
    generateName: load-tests-
    labels:
        app: ai-incident-assistant
        test-type: load
spec:
    serviceAccountName: argo-workflow
    entrypoint: load-test-suite
    
    # Input parameters
    arguments:
        parameters:
            - name: image_tag
              value: "latest"
            - name: staging_url
              value: "http://staging.174.138.120.13.nip.io"
            - name: duration
              value: "5m"
            - name: users
              value: "50"
        
    # TTL for workflow cleanup
    ttlStrategy:
        secondsAfterCompletion: 86400  # 24 hours
        secondsAfterSuccess: 43200      # 12 hours
        secondsAfterFailure: 172800     # 48 hours
        
    templates:
        # ============================================
        # Main Load Test Suite
        # ============================================
        - name: load-test-suite
          dag:
              tasks:
                  - name: setup
                    template: setup-tests
                    
                  - name: health-check
                    template: health-check
                    dependencies: [setup]
                    
                  - name: smoke-test
                    template: run-smoke-test
                    dependencies: [health-check]
                    
                  - name: load-test
                    template: run-load-test
                    dependencies: [smoke-test]
                    
                  - name: report-results
                    template: generate-report
                    dependencies: [load-test]

        # ============================================
        # Setup Template
        # ============================================
        - name: setup-tests
          container:
              image: alpine:3.18
              command: [sh, -c]
              args:
                  - |
                      echo "ðŸ“Š Load Test Setup"
                      echo "================================"
                      echo "Image Tag: {{workflow.parameters.image_tag}}"
                      echo "Staging URL: {{workflow.parameters.staging_url}}"
                      echo "Duration: {{workflow.parameters.duration}}"
                      echo "Virtual Users: {{workflow.parameters.users}}"
                      echo "================================"
                      echo "Setup complete!"

        # ============================================
        # Health Check Template
        # ============================================
        - name: health-check
          container:
              image: curlimages/curl:8.5.0
              command: [sh, -c]
              args:
                  - |
                      echo "ðŸ¥ Running health checks..."
                      
                      # Check frontend
                      echo "Checking frontend..."
                      for i in $(seq 1 10); do
                        if curl -sf "{{workflow.parameters.staging_url}}" > /dev/null; then
                          echo "âœ… Frontend is healthy"
                          break
                        fi
                        echo "Waiting for frontend... ($i/10)"
                        sleep 5
                      done
                      
                      # Check backend API
                      echo "Checking backend API..."
                      for i in $(seq 1 10); do
                        if curl -sf "{{workflow.parameters.staging_url}}/api/health" > /dev/null; then
                          echo "âœ… Backend API is healthy"
                          break
                        fi
                        echo "Waiting for backend... ($i/10)"
                        sleep 5
                      done
                      
                      echo "âœ… All health checks passed!"
          retryStrategy:
              limit: 3
              retryPolicy: "Always"

        # ============================================
        # Smoke Test with k6
        # ============================================
        - name: run-smoke-test
          script:
              image: grafana/k6:latest
              command: [sh]
              securityContext:
                  runAsUser: 0
              source: |
                  #!/bin/sh
                  set -e
                  
                  echo "ðŸ”¥ Running Smoke Test..."
                  
                  # Clone repository to get test files
                  apk add --no-cache git
                  git clone https://github.com/0019-KDU/cloud-native-ci-cd-blueprint.git /workspace
                  cd /workspace/tests/load
                  
                  # Run smoke test
                  k6 run \
                    --vus 1 \
                    --duration 30s \
                    --env BASE_URL="{{workflow.parameters.staging_url}}" \
                    smoke-test.js
                  
                  echo "âœ… Smoke test completed!"

        # ============================================
        # Load Test with k6
        # ============================================
        - name: run-load-test
          script:
              image: grafana/k6:latest
              command: [sh]
              securityContext:
                  runAsUser: 0
              source: |
                  #!/bin/sh
                  set -e
                  
                  echo "ðŸ“Š Running Load Test..."
                  
                  # Clone repository to get test files
                  apk add --no-cache git
                  git clone https://github.com/0019-KDU/cloud-native-ci-cd-blueprint.git /workspace
                  cd /workspace/tests/load
                  
                  # Run load test
                  k6 run \
                    --vus {{workflow.parameters.users}} \
                    --duration {{workflow.parameters.duration}} \
                    --env BASE_URL="{{workflow.parameters.staging_url}}" \
                    load-test.js
                  
                  echo "âœ… Load test completed!"

        # ============================================
        # Generate Report
        # ============================================
        - name: generate-report
          container:
              image: alpine:3.18
              command: [sh, -c]
              args:
                  - |
                      echo "ðŸ“‹ Generating Load Test Report..."
                      echo "================================"
                      echo "âœ… All load tests completed successfully!"
                      echo "Results have been collected and analyzed."
                      echo "================================"
                      echo "Test artifacts have been saved."