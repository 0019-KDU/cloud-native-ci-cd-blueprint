apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
    name: backend
    namespace: prod
    labels:
        app: backend
spec:
    replicas: 3
    revisionHistoryLimit: 3
    selector:
        matchLabels:
            app: backend
    template:
        metadata:
            labels:
                app: backend
        spec:
            containers:
                - name: backend
                  image: registry.digitalocean.com/ai-incident-assistant/backend:latest
                  ports:
                      - containerPort: 3001
                  env:
                      - name: NODE_ENV
                        value: "production"
                      - name: PORT
                        value: "3001"
                      - name: DB_HOST
                        value: "postgres"
                      - name: DB_PORT
                        value: "5432"
                      - name: DB_NAME
                        valueFrom:
                            configMapKeyRef:
                                name: backend-config
                                key: DATABASE_NAME
                      - name: DB_USER
                        valueFrom:
                            secretKeyRef:
                                name: postgres-secret
                                key: username
                      - name: DB_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: postgres-secret
                                key: password
                      - name: OPENAI_API_KEY
                        valueFrom:
                            secretKeyRef:
                                name: backend-secret
                                key: openai-api-key
                  resources:
                      requests:
                          memory: "256Mi"
                          cpu: "250m"
                      limits:
                          memory: "512Mi"
                          cpu: "500m"
                  readinessProbe:
                      httpGet:
                          path: /api/health
                          port: 3001
                      initialDelaySeconds: 10
                      periodSeconds: 5
                  livenessProbe:
                      httpGet:
                          path: /api/health
                          port: 3001
                      initialDelaySeconds: 15
                      periodSeconds: 10
    strategy:
        blueGreen:
            # Active service (receives production traffic)
            activeService: backend-active
            # Preview service (receives test traffic during deployment)
            previewService: backend-preview
            # Auto-promote after preview tests pass (or set to false for manual)
            autoPromotionEnabled: false
            # Time to wait before scaling down old version
            scaleDownDelaySeconds: 300
            # Preview ReplicaSet scale
            previewReplicaCount: 2
            # Anti-affinity for spreading pods
            antiAffinity:
                requiredDuringSchedulingIgnoredDuringExecution: {}

---
apiVersion: v1
kind: Service
metadata:
    name: backend-active
    namespace: prod
    labels:
        app: backend
spec:
    selector:
        app: backend
    ports:
        - port: 80
          targetPort: 3000
    type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
    name: backend-preview
    namespace: prod
    labels:
        app: backend
spec:
    selector:
        app: backend
    ports:
        - port: 80
          targetPort: 3000
    type: ClusterIP

---
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
    name: frontend
    namespace: prod
    labels:
        app: frontend
spec:
    replicas: 3
    revisionHistoryLimit: 3
    selector:
        matchLabels:
            app: frontend
    template:
        metadata:
            labels:
                app: frontend
        spec:
            containers:
                - name: frontend
                  image: registry.digitalocean.com/ai-incident-assistant/frontend:latest
                  ports:
                      - containerPort: 80
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "256Mi"
                          cpu: "200m"
                  readinessProbe:
                      httpGet:
                          path: /
                          port: 80
                      initialDelaySeconds: 5
                      periodSeconds: 5
                  livenessProbe:
                      httpGet:
                          path: /
                          port: 80
                      initialDelaySeconds: 10
                      periodSeconds: 10
    strategy:
        blueGreen:
            activeService: frontend-active
            previewService: frontend-preview
            autoPromotionEnabled: false
            scaleDownDelaySeconds: 300
            previewReplicaCount: 2

---
apiVersion: v1
kind: Service
metadata:
    name: frontend-active
    namespace: prod
    labels:
        app: frontend
spec:
    selector:
        app: frontend
    ports:
        - port: 80
          targetPort: 80
    type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
    name: frontend-preview
    namespace: prod
    labels:
        app: frontend
spec:
    selector:
        app: frontend
    ports:
        - port: 80
          targetPort: 80
    type: ClusterIP

---
# Ingress for production traffic
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: prod-ingress
    namespace: prod
    annotations:
        kubernetes.io/ingress.class: nginx
spec:
    rules:
        - host: app.174.138.120.13.nip.io
          http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: backend-active
                            port:
                                number: 80
                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: frontend-active
                            port:
                                number: 80

---
# Ingress for preview traffic (testing new version)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: prod-preview-ingress
    namespace: prod
    annotations:
        kubernetes.io/ingress.class: nginx
spec:
    rules:
        - host: preview.174.138.120.13.nip.io
          http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: backend-preview
                            port:
                                number: 80
                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: frontend-preview
                            port:
                                number: 80