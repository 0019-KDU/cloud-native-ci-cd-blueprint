name: Production Deployment Pipeline

on:
    workflow_dispatch:
        inputs:
            image_tag:
                description: "Image tag to deploy (git commit SHA)"
                required: true
                type: string

env:
    PROD_URL: http://prod.174.138.120.13.nip.io
    ARGOCD_SERVER: 209.38.124.183

jobs:
    # ================================
    # Pre-deployment Validation
    # ================================
    pre-deployment-check:
        name: Pre-deployment Validation
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Verify image exists in registry
              run: |
                  echo "üîç Verifying images exist..."

                  doctl registry login

                  # Check backend image
                  if doctl registry repository list-tags backend | grep -q "${{ github.event.inputs.image_tag }}"; then
                    echo "‚úÖ Backend image found: ${{ github.event.inputs.image_tag }}"
                  else
                    echo "‚ùå Backend image not found: ${{ github.event.inputs.image_tag }}"
                    exit 1
                  fi

                  # Check frontend image
                  if doctl registry repository list-tags frontend | grep -q "${{ github.event.inputs.image_tag }}"; then
                    echo "‚úÖ Frontend image found: ${{ github.event.inputs.image_tag }}"
                  else
                    echo "‚ùå Frontend image not found: ${{ github.event.inputs.image_tag }}"
                    exit 1
                  fi

            - name: Verify staging tests passed
              run: |
                  echo "üìä Checking staging test results..."
                  # This would query your test results database or artifacts
                  # For now, manual verification required
                  echo "‚ö†Ô∏è Manual verification: Ensure staging tests passed for commit ${{ github.event.inputs.image_tag }}"

    # ================================
    # Create Deployment PR
    # ================================
    create-deployment-pr:
        name: Create Production Deployment PR
        needs: pre-deployment-check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create deployment branch
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

                  branch_name="deploy/prod-${{ github.event.inputs.image_tag }}"
                  git checkout -b $branch_name

                  echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

            - name: Update production manifests
              working-directory: infra/k8s/overlays/prod
              run: |
                  # Update image tags
                  kustomize edit set image \
                    registry.digitalocean.com/ai-incident-assistant/backend=registry.digitalocean.com/ai-incident-assistant/backend:${{ github.event.inputs.image_tag }}

                  kustomize edit set image \
                    registry.digitalocean.com/ai-incident-assistant/frontend=registry.digitalocean.com/ai-incident-assistant/frontend:${{ github.event.inputs.image_tag }}

            - name: Commit changes
              run: |
                  git add infra/k8s/overlays/prod/kustomization.yaml
                  git commit -m "deploy: production release ${{ github.event.inputs.image_tag }}

                  üöÄ Production Deployment Request

                  **Image Tag**: ${{ github.event.inputs.image_tag }}
                  **Requested by**: ${{ github.actor }}
                  **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

                  ## Changes
                  - Backend: registry.digitalocean.com/ai-incident-assistant/backend:${{ github.event.inputs.image_tag }}
                  - Frontend: registry.digitalocean.com/ai-incident-assistant/frontend:${{ github.event.inputs.image_tag }}

                  ## Pre-deployment Checklist
                  - [x] Images verified in registry
                  - [x] Staging tests passed
                  - [ ] Manual approval required
                  - [ ] Database migrations reviewed
                  - [ ] Rollback plan prepared"

                  git push origin ${{ env.BRANCH_NAME }}

            - name: Create Pull Request
              uses: actions/github-script@v7
              with:
                  script: |
                      const pr = await github.rest.pulls.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: `üöÄ Production Deployment: ${context.payload.inputs.image_tag}`,
                        head: process.env.BRANCH_NAME,
                        base: 'main',
                        body: `## Production Deployment Request
                        
                        ### üì¶ Release Information
                        - **Image Tag**: \`${context.payload.inputs.image_tag}\`
                        - **Requested by**: @${context.actor}
                        - **Date**: ${new Date().toISOString()}
                        
                        ### ‚úÖ Pre-deployment Validation
                        - [x] Images exist in DigitalOcean Registry
                        - [x] Pre-deployment checks passed
                        - [ ] **REQUIRED: Manual approval from team lead**
                        - [ ] Database migrations reviewed (if any)
                        - [ ] Rollback plan documented
                        
                        ### üéØ Deployment Targets
                        - **Environment**: Production
                        - **URL**: http://prod.174.138.120.13.nip.io
                        - **ArgoCD**: http://209.38.124.183
                        
                        ### üîç Changes
                        - Backend: \`registry.digitalocean.com/ai-incident-assistant/backend:${context.payload.inputs.image_tag}\`
                        - Frontend: \`registry.digitalocean.com/ai-incident-assistant/frontend:${context.payload.inputs.image_tag}\`
                        
                        ### üìã Deployment Steps
                        1. Review and approve this PR
                        2. Merge to main branch
                        3. Manually sync ArgoCD production application
                        4. Monitor deployment in ArgoCD
                        5. Run smoke tests (automated)
                        6. Verify production health
                        
                        ### üö® Rollback Plan
                        If issues occur:
                        1. Revert this PR
                        2. Sync ArgoCD with previous version
                        3. Monitor recovery
                        
                        ### üß™ Test Results
                        Review staging test results: [Staging Validation Workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/staging-validation.yml)
                        
                        ---
                        
                        **‚ö†Ô∏è IMPORTANT**: This PR requires manual review and approval before merging.
                        Do not enable auto-merge for production deployments.`
                      });

                      // Add labels
                      await github.rest.issues.addLabels({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: pr.data.number,
                        labels: ['deployment', 'production', 'needs-approval']
                      });

                      // Request reviews from team leads
                      await github.rest.pulls.requestReviewers({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: pr.data.number,
                        reviewers: ['team-lead-username'] // Replace with actual usernames
                      });

                      core.setOutput('pr_number', pr.data.number);
                      core.setOutput('pr_url', pr.data.html_url);

        outputs:
            pr_number: ${{ steps.create-pr.outputs.pr_number }}
            pr_url: ${{ steps.create-pr.outputs.pr_url }}
