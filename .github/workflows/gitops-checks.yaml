name: GitOps PR Checks

# This workflow provides required status checks for GitOps PRs
# (PRs that only change kustomization files)

on:
    pull_request:
        branches:
            - main
        paths:
            - "infra/k8s/overlays/**"

jobs:
    # These jobs satisfy the required status checks
    # when only kustomization files change

    build-scan-backend:
        name: Build & Scan Backend
        runs-on: ubuntu-latest
        steps:
            - name: Skip - GitOps PR
              run: |
                  echo "âœ… Skipping build - this is a GitOps PR"
                  echo "Only kustomization files changed"
                  echo ""
                  echo "This job satisfies the required status check"

    build-scan-frontend:
        name: Build & Scan Frontend
        runs-on: ubuntu-latest
        steps:
            - name: Skip - GitOps PR
              run: |
                  echo "âœ… Skipping build - this is a GitOps PR"
                  echo "Only kustomization files changed"
                  echo ""
                  echo "This job satisfies the required status check"

    validate-kustomization:
        name: Validate Kustomization
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install kustomize
              run: |
                  curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
                  sudo mv kustomize /usr/local/bin/

            - name: Validate dev kustomization
              run: |
                  if [ -f "infra/k8s/overlays/dev/kustomization.yaml" ]; then
                    echo "ðŸ” Validating dev kustomization..."
                    kustomize build infra/k8s/overlays/dev > /dev/null
                    echo "âœ… Dev kustomization is valid"
                  fi

            - name: Validate staging kustomization
              run: |
                  if [ -f "infra/k8s/overlays/staging/kustomization.yaml" ]; then
                    echo "ðŸ” Validating staging kustomization..."
                    kustomize build infra/k8s/overlays/staging > /dev/null
                    echo "âœ… Staging kustomization is valid"
                  fi

            - name: Validate prod kustomization
              run: |
                  if [ -f "infra/k8s/overlays/prod/kustomization.yaml" ]; then
                    echo "ðŸ” Validating prod kustomization..."
                    kustomize build infra/k8s/overlays/prod > /dev/null
                    echo "âœ… Prod kustomization is valid"
                  fi

            - name: Summary
              run: |
                  echo ""
                  echo "âœ… All kustomization files are valid!"
