name: CI/CD - Staging Environment

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (leave empty for latest from dev)"
        required: false
        type: string
      skip_tests:
        description: "Skip E2E and Load tests"
        required: false
        type: boolean
        default: false
      run_load_test:
        description: "Run load tests"
        required: false
        type: boolean
        default: true
      run_e2e_test:
        description: "Run E2E tests"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: ai-incident-assistant
  STAGING_NAMESPACE: staging
  ARGO_WORKFLOWS_URL: ${{ secrets.ARGO_WORKFLOWS_URL }}

jobs:
  # ============================================
  # JOB 1: Determine Image Tag
  # ============================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get-tag.outputs.image_tag }}
      needs_update: ${{ steps.check-diff.outputs.needs_update }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get image tag
        id: get-tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            # Use provided tag
            echo "image_tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "üì¶ Using provided image tag: ${{ inputs.image_tag }}"
          else
            # Get current tag from dev environment
            DEV_TAG=$(grep "newTag:" infra/k8s/overlays/dev/kustomization.yaml | head -1 | sed 's/.*newTag:\s*//; s/"//g; s/^[[:space:]]*//; s/[[:space:]]*$//')
            echo "image_tag=$DEV_TAG" >> $GITHUB_OUTPUT
            echo "üì¶ Using dev image tag: $DEV_TAG"
          fi

      - name: Check if staging needs update
        id: check-diff
        run: |
          # Get current staging tag
          STAGING_TAG=$(grep "newTag:" infra/k8s/overlays/staging/kustomization.yaml | head -1 | sed 's/.*newTag:\s*//; s/"//g; s/^[[:space:]]*//; s/[[:space:]]*$//')
          TARGET_TAG="${{ steps.get-tag.outputs.image_tag }}"

          echo "Current staging tag: $STAGING_TAG"
          echo "Target tag: $TARGET_TAG"

          if [ "$STAGING_TAG" = "$TARGET_TAG" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Staging is already at $TARGET_TAG - will run tests only"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "üîÑ Staging needs update from $STAGING_TAG to $TARGET_TAG - will deploy + test"
          fi

  # ============================================
  # JOB 2: Update Staging Manifests
  # ============================================
  update-staging-manifests:
    name: Update Staging Manifests
    runs-on: ubuntu-latest
    needs: [prepare]
    if: needs.prepare.outputs.needs_update == 'true'
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create staging deployment branch
        run: |
          BRANCH_NAME="deploy/staging-${{ needs.prepare.outputs.image_tag }}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update staging kustomization
        run: |
          cd infra/k8s/overlays/staging
          sed -i "s|newTag:.*|newTag: \"${{ needs.prepare.outputs.image_tag }}\"|g" kustomization.yaml

          echo "üìù Updated staging kustomization.yaml:"
          cat kustomization.yaml

      - name: Commit and push
        run: |
          # Check if there are changes
          if git diff --quiet infra/k8s/overlays/staging/kustomization.yaml; then
            echo "‚ö†Ô∏è No changes detected - image tag is already ${{ needs.prepare.outputs.image_tag }}"
            echo "Skipping PR creation as staging is already at this version"
            echo "skip_pr=true" >> $GITHUB_ENV
          else
            git add infra/k8s/overlays/staging/kustomization.yaml
            git commit -m "üöÄ Deploy to staging: ${{ needs.prepare.outputs.image_tag }} [skip ci]"
            git push origin ${{ env.BRANCH_NAME }}
            echo "skip_pr=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.skip_pr != 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "üé≠ Deploy to Staging: ${{ needs.prepare.outputs.image_tag }}" \
            --body "## Staging Deployment

          ### üì¶ Image Tag
          \`${{ needs.prepare.outputs.image_tag }}\`

          ### üß™ Tests to Run
          - E2E Tests: ${{ inputs.run_e2e_test && '‚úÖ Yes' || '‚è≠Ô∏è Skipped' }}
          - Load Tests: ${{ inputs.run_load_test && '‚úÖ Yes' || '‚è≠Ô∏è Skipped' }}

          ### ‚ö° What happens next?
          1. This PR merges after approval
          2. ArgoCD syncs to staging (manual sync required)
          3. Argo Workflow runs E2E and Load tests
          4. Slack notification on completion

          ---
          *ü§ñ Triggered by: @${{ github.actor }}*" \
            --base main \
            --head ${{ env.BRANCH_NAME }})

          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --json number --jq '.[0].number')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

  # ============================================
  # JOB 3: Run E2E Tests BEFORE Merge
  # ============================================
  e2e-tests:
    name: E2E Tests (Argo Workflow)
    runs-on: ubuntu-latest
    needs: [prepare, update-staging-manifests]
    if: ${{ inputs.run_e2e_test != false && needs.prepare.outputs.needs_update == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        run: |
          sudo snap install doctl
          sudo snap connect doctl:kube-config
          mkdir -p $HOME/.kube
          doctl auth init --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save ai-incident-assistant

      - name: Install Argo CLI
        run: |
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.5.4/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          sudo mv argo-linux-amd64 /usr/local/bin/argo

      - name: Submit E2E Test Workflow
        id: submit-e2e
        run: |
          WORKFLOW_NAME=$(argo submit infra/argo-workflows/e2e-tests.yaml \
            -n argo \
            --parameter image_tag=${{ needs.prepare.outputs.image_tag }} \
            --parameter staging_url=http://staging.174.138.120.13.nip.io \
            -o name)

          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "üß™ Submitted E2E workflow: $WORKFLOW_NAME"

      - name: Wait for E2E Tests
        run: |
          echo "‚è≥ Waiting for E2E tests to complete..."
          argo wait ${{ steps.submit-e2e.outputs.workflow_name }} -n argo

      - name: Get E2E Results
        if: always()
        run: |
          argo get ${{ steps.submit-e2e.outputs.workflow_name }} -n argo

          # Check status
          STATUS=$(argo get ${{ steps.submit-e2e.outputs.workflow_name }} -n argo -o json | jq -r '.status.phase')
          if [ "$STATUS" != "Succeeded" ]; then
            echo "‚ùå E2E tests failed!"
            argo logs ${{ steps.submit-e2e.outputs.workflow_name }} -n argo
            exit 1
          fi

          echo "‚úÖ E2E tests passed!"

  # ============================================
  # JOB 4: Run Load Tests BEFORE Merge
  # ============================================
  load-tests:
    name: Load Tests (Argo Workflow)
    runs-on: ubuntu-latest
    needs: [prepare, update-staging-manifests, e2e-tests]
    if: ${{ inputs.run_load_test != false && needs.e2e-tests.result == 'success' && needs.prepare.outputs.needs_update == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        run: |
          sudo snap install doctl
          sudo snap connect doctl:kube-config
          mkdir -p $HOME/.kube
          doctl auth init --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save ai-incident-assistant

      - name: Install Argo CLI
        run: |
          curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.5.4/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          sudo mv argo-linux-amd64 /usr/local/bin/argo

      - name: Submit Load Test Workflow
        id: submit-load
        run: |
          WORKFLOW_NAME=$(argo submit infra/argo-workflows/load-tests.yaml \
            -n argo \
            --parameter image_tag=${{ needs.prepare.outputs.image_tag }} \
            --parameter staging_url=http://staging.174.138.120.13.nip.io \
            --parameter duration=5m \
            --parameter users=50 \
            -o name)

          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "üìä Submitted Load Test workflow: $WORKFLOW_NAME"

      - name: Wait for Load Tests
        run: |
          echo "‚è≥ Waiting for load tests to complete..."
          argo wait ${{ steps.submit-load.outputs.workflow_name }} -n argo

      - name: Get Load Test Results
        if: always()
        run: |
          argo get ${{ steps.submit-load.outputs.workflow_name }} -n argo

          STATUS=$(argo get ${{ steps.submit-load.outputs.workflow_name }} -n argo -o json | jq -r '.status.phase')
          if [ "$STATUS" != "Succeeded" ]; then
            echo "‚ùå Load tests failed!"
            argo logs ${{ steps.submit-load.outputs.workflow_name }} -n argo
            exit 1
          fi

          echo "‚úÖ Load tests passed!"

  # ============================================
  # JOB 5: Merge ONLY AFTER Tests Pass
  # ============================================
  merge-and-sync:
    name: Merge and Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, update-staging-manifests, e2e-tests, load-tests]
    if: needs.prepare.outputs.needs_update == 'true' && needs.e2e-tests.result == 'success' && (needs.load-tests.result == 'success' || needs.load-tests.result == 'skipped')
    environment:
      name: staging
      url: http://staging.174.138.120.13.nip.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Post test results to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ needs.update-staging-manifests.outputs.pr_number }}"

          gh pr comment $PR_NUMBER --body "## ‚úÖ All Tests Passed!

          ### Test Results:
          - ‚úÖ E2E Tests: Passed
          - ‚úÖ Load Tests: ${{ needs.load-tests.result == 'success' && 'Passed' || 'Skipped' }}

          **Manual approval required to merge and deploy to staging.**"

          echo "‚úÖ Test results posted to PR #$PR_NUMBER"
          echo ""
          echo "‚è∏Ô∏è Waiting for manual approval in GitHub environment: staging"

      - name: Install doctl
        run: |
          sudo snap install doctl
          sudo snap connect doctl:kube-config
          mkdir -p $HOME/.kube
          doctl auth init --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save ai-incident-assistant

      - name: Merge PR after approval
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ needs.update-staging-manifests.outputs.pr_number }}"

          echo "‚úÖ Manual approval received"
          echo "üîÄ Merging PR #$PR_NUMBER..."

          gh pr merge $PR_NUMBER --squash

          echo "‚úÖ PR #$PR_NUMBER merged to main"

      - name: Wait for PR merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚è≥ Waiting for PR to merge..."
          for i in {1..30}; do
            STATE=$(gh pr view ${{ needs.update-staging-manifests.outputs.pr_number }} --json state --jq '.state')
            if [ "$STATE" = "MERGED" ]; then
              echo "‚úÖ PR merged!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done

      - name: Trigger ArgoCD Sync
        run: |
          echo "üîÑ Triggering ArgoCD sync for staging..."
          kubectl patch application ai-incident-staging -n argocd \
            --type merge \
            -p '{"operation": {"initiatedBy": {"username": "github-actions"}, "sync": {"revision": "HEAD"}}}' \
            || echo "Manual sync may be required"

      - name: Wait for rollout
        run: |
          echo "‚è≥ Waiting for staging deployment..."
          kubectl rollout status deployment/backend -n ${{ env.STAGING_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/frontend -n ${{ env.STAGING_NAMESPACE }} --timeout=5m
          echo "‚úÖ Staging deployment complete!"

  # ============================================
  # JOB 6: Notify Results
  # ============================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [prepare, e2e-tests, load-tests, merge-and-sync]
    if: always()

    steps:
      - name: Send Slack - Success
        if: ${{ needs.e2e-tests.result == 'success' && (needs.load-tests.result == 'success' || needs.load-tests.result == 'skipped') }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "‚úÖ Staging deployment successful!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Staging Deployment Complete"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Image Tag:*\n`${{ needs.prepare.outputs.image_tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*E2E Tests:*\n${{ needs.e2e-tests.result == 'success' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Load Tests:*\n${{ needs.load-tests.result == 'success' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üé≠ <http://staging.174.138.120.13.nip.io|View Staging Environment>\n\n*Ready for production deployment!*"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack - Failure
        if: ${{ needs.e2e-tests.result == 'failure' || needs.load-tests.result == 'failure' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "‚ùå Staging deployment failed!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Staging Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Image Tag:*\n`${{ needs.prepare.outputs.image_tag }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*E2E Tests:*\n${{ needs.e2e-tests.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Load Tests:*\n${{ needs.load-tests.result }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|üîó View Failed Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
