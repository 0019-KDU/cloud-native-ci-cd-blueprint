name: PR Validation

# This workflow runs ONLY on Pull Requests to main
# It performs tests and quality checks WITHOUT building or deploying

on:
    pull_request:
        branches:
            - main
        paths:
            - "backend/**"
            - "frontend/**"
            - "tests/**"
            - ".github/workflows/pr-validation.yaml"

permissions:
    contents: read
    security-events: write
    pull-requests: write

jobs:
    # ============================================
    # JOB 1: Backend Tests & SonarQube
    # ============================================
    backend-test:
        name: Backend Tests & SonarQube
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: Install dependencies
              working-directory: backend
              run: npm ci

            - name: Run lint
              working-directory: backend
              run: npm run lint

            - name: Run tests with coverage
              working-directory: backend
              run: npm test -- --coverage

            - name: SonarQube Scan - Backend
              uses: SonarSource/sonarqube-scan-action@master
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              with:
                  projectBaseDir: backend
                  args: >
                      -Dsonar.projectKey=ai-incident-backend
                      -Dsonar.sources=src
                      -Dsonar.tests=src/__tests__
                      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

            - name: Summary
              run: |
                  echo "✅ Backend tests passed!"
                  echo "✅ Code quality checked with SonarQube"

    # ============================================
    # JOB 2: Frontend Tests & SonarQube
    # ============================================
    frontend-test:
        name: Frontend Tests & SonarQube
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: frontend
              run: npm ci

            - name: Run lint
              working-directory: frontend
              run: npm run lint

            - name: Run tests
              working-directory: frontend
              run: |
                  # Check if test script exists
                  if npm run | grep -q "test"; then
                    npm test -- --passWithNoTests
                  else
                    echo "⚠️ No test script found - skipping tests"
                    echo "Frontend validation will rely on linting and SonarQube"
                  fi

            - name: SonarQube Scan - Frontend
              uses: SonarSource/sonarqube-scan-action@master
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              with:
                  projectBaseDir: frontend
                  args: >
                      -Dsonar.projectKey=ai-incident-frontend
                      -Dsonar.sources=src

            - name: Summary
              run: |
                  echo "✅ Frontend tests passed!"
                  echo "✅ Code quality checked with SonarQube"

    # ============================================
    # JOB 3: PR Summary
    # ============================================
    pr-summary:
        name: PR Validation Summary
        runs-on: ubuntu-latest
        needs: [backend-test, frontend-test]
        if: always()

        steps:
            - name: Check results
              run: |
                  if [[ "${{ needs.backend-test.result }}" != "success" ]] || [[ "${{ needs.frontend-test.result }}" != "success" ]]; then
                    echo "❌ PR validation failed!"
                    echo ""
                    echo "Backend Tests: ${{ needs.backend-test.result }}"
                    echo "Frontend Tests: ${{ needs.frontend-test.result }}"
                    exit 1
                  fi

                  echo "✅ All PR validations passed!"
                  echo ""
                  echo "✔️ Backend tests & SonarQube"
                  echo "✔️ Frontend tests & SonarQube"
                  echo ""
                  echo "This PR is ready to merge to main"
                  echo "After merge, images will be built and dev will be updated automatically"
