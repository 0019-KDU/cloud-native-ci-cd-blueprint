name: CI Pipeline - Build Once Deploy Many

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/ci-pipeline.yml"
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.digitalocean.com/ai-incident-assistant
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ================================
  # Backend Pipeline
  # ================================
  backend-test:
    name: Backend - Test & Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter (strict)
        run: npm run lint

      - name: Run unit tests with coverage threshold
        run: npm run test:ci

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: |
            backend/coverage/
            backend/junit.xml
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: backend
          args: >
            -Dsonar.projectKey=ai-incident-assistant-backend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.js
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  backend-build:
    name: Backend - Build & Push Image
    needs: backend-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build backend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/backend:latest \
            -f infra/docker/backend.Dockerfile \
            .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/backend:${{ env.IMAGE_TAG }}
          format: "sarif"
          output: "trivy-backend-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-backend-results.sarif"
          category: "backend-container-scan"

      - name: Push image and capture digest
        id: push
        run: |
          # Push with tag
          docker push ${{ env.REGISTRY }}/backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.REGISTRY }}/backend:latest

          # Get image digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.REGISTRY }}/backend:${{ env.IMAGE_TAG }} | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "tag=${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.REGISTRY }}/backend@$DIGEST" >> $GITHUB_OUTPUT

          echo "âœ… Image pushed with digest: $DIGEST"

    outputs:
      image_tag: ${{ steps.push.outputs.tag }}
      image_digest: ${{ steps.push.outputs.digest }}
      full_image: ${{ steps.push.outputs.full_image }}

  # ================================
  # Frontend Pipeline
  # ================================
  frontend-test:
    name: Frontend - Test & Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter (strict)
        run: npm run lint

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: frontend
          args: >
            -Dsonar.projectKey=ai-incident-assistant-frontend
            -Dsonar.sources=src
            -Dsonar.javascript.node.maxspace=4096

  frontend-build:
    name: Frontend - Build & Push Image
    needs: frontend-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build frontend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/frontend:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/frontend:latest \
            -f infra/docker/frontend.Dockerfile \
            .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/frontend:${{ env.IMAGE_TAG }}
          format: "sarif"
          output: "trivy-frontend-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-frontend-results.sarif"
          category: "frontend-container-scan"

      - name: Push image and capture digest
        id: push
        run: |
          # Push with tag
          docker push ${{ env.REGISTRY }}/frontend:${{ env.IMAGE_TAG }}
          docker push ${{ env.REGISTRY }}/frontend:latest

          # Get image digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.REGISTRY }}/frontend:${{ env.IMAGE_TAG }} | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "tag=${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.REGISTRY }}/frontend@$DIGEST" >> $GITHUB_OUTPUT

          echo "âœ… Image pushed with digest: $DIGEST"

    outputs:
      image_tag: ${{ steps.push.outputs.tag }}
      image_digest: ${{ steps.push.outputs.digest }}
      full_image: ${{ steps.push.outputs.full_image }}

  # ================================
  # Update K8s Manifests (Same Repo)
  # ================================
  update-k8s-manifests:
    name: Update K8s Manifests
    needs: [backend-build, frontend-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate Kustomize templates
        run: |
          echo "ðŸ” Validating Kustomize templates..."

          for env in dev staging prod; do
            echo "Validating $env overlay..."
            kustomize build infra/k8s/overlays/$env > /tmp/k8s-$env.yaml
            
            # Check if build succeeded and produced valid YAML
            if [ -s /tmp/k8s-$env.yaml ]; then
              echo "âœ… $env overlay is valid"
            else
              echo "âŒ $env overlay validation failed"
              exit 1
            fi
          done

      - name: Update image tags in dev overlay
        working-directory: infra/k8s/overlays/dev
        run: |
          # Update backend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/backend=registry.digitalocean.com/ai-incident-assistant/backend:${{ env.IMAGE_TAG }}

          # Update frontend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/frontend=registry.digitalocean.com/ai-incident-assistant/frontend:${{ env.IMAGE_TAG }}

      - name: Update image tags in staging overlay
        working-directory: infra/k8s/overlays/staging
        run: |
          # Update backend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/backend=registry.digitalocean.com/ai-incident-assistant/backend:${{ env.IMAGE_TAG }}

          # Update frontend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/frontend=registry.digitalocean.com/ai-incident-assistant/frontend:${{ env.IMAGE_TAG }}

      - name: Update image tags in prod overlay
        working-directory: infra/k8s/overlays/prod
        run: |
          # Update backend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/backend=registry.digitalocean.com/ai-incident-assistant/backend:${{ env.IMAGE_TAG }}

          # Update frontend image tag
          kustomize edit set image \
            registry.digitalocean.com/ai-incident-assistant/frontend=registry.digitalocean.com/ai-incident-assistant/frontend:${{ env.IMAGE_TAG }}

      - name: Create PR with manifest updates
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update image tags to ${{ env.IMAGE_TAG }}
            
            Backend: ${{ needs.backend-build.outputs.image_tag }}
            Frontend: ${{ needs.frontend-build.outputs.image_tag }}
            
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
          branch: automated/update-manifests-${{ env.IMAGE_TAG }}
          delete-branch: true
          title: "chore: update K8s manifests to ${{ env.IMAGE_TAG }}"
          body: |
            ## ðŸ“¦ Automated Manifest Update
            
            This PR updates the Kubernetes manifests with new image tags from the latest build.
            
            ### Changes
            - **Backend**: `${{ needs.backend-build.outputs.image_tag }}`
            - **Frontend**: `${{ needs.frontend-build.outputs.image_tag }}`
            
            ### Affected Environments
            - âœ… Dev overlay updated
            - âœ… Staging overlay updated  
            - âœ… Prod overlay updated
            
            ### Next Steps
            1. Review the manifest changes
            2. Approve and merge this PR
            3. ArgoCD will auto-sync dev environment
            4. Staging validation will run automatically
            5. Production deployment requires manual workflow trigger
            
            **Triggered by**: @${{ github.actor }}
            **Source commit**: ${{ github.sha }}
          labels: |
            automated
            kubernetes
            deployment

  # ================================
  # Deployment Summary
  # ================================
  deployment-summary:
    name: Deployment Summary
    needs: [update-k8s-manifests]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Pipeline Summary

          ### âœ… Images Built and Pushed
          - **Backend**: `registry.digitalocean.com/ai-incident-assistant/backend:${{ env.IMAGE_TAG }}`
          - **Frontend**: `registry.digitalocean.com/ai-incident-assistant/frontend:${{ env.IMAGE_TAG }}`

          ### ðŸ“ K8s Manifests Updated
          Repository: `cloud-native-ci-cd-blueprint`

          Image tags updated in:
          - âœ… `infra/k8s/overlays/dev/kustomization.yaml`
          - âœ… `infra/k8s/overlays/staging/kustomization.yaml`
          - âœ… `infra/k8s/overlays/prod/kustomization.yaml`

          ### ðŸŽ¯ ArgoCD Deployment Status
          - **Dev**: ðŸŸ¢ Auto-sync enabled (deploying now)
          - **Staging**: ðŸŸ¡ Manual sync required (awaiting approval)
          - **Production**: ðŸŸ¡ Manual sync required (awaiting approval)

          ### ðŸ”— Next Steps
          1. Verify dev deployment in ArgoCD
          2. Run E2E tests against dev environment
          3. Manually sync staging in ArgoCD
          4. Run staging validation tests
          5. Manually sync production in ArgoCD

          ---
          **Commit**: ${{ github.sha }}
          **Triggered by**: ${{ github.actor }}
          **Workflow**: ${{ github.workflow }}
          EOF
