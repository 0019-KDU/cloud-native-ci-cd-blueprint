name: Mark Build as Production Ready

on:
    workflow_run:
        workflows: ["Staging Validation Tests"]
        types:
            - completed
        branches: [main]

jobs:
    mark-prod-approved:
        name: Tag as Production Approved
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get current staging image tag
              id: get-tag
              run: |
                  cd infra/k8s/overlays/staging
                  TAG=$(kustomize edit view | grep 'newTag:' | head -1 | awk '{print $2}')
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Current staging image tag: $TAG"

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Tag Docker images as prod-approved
              run: |
                  doctl registry login

                  TAG="${{ steps.get-tag.outputs.tag }}"

                  echo "ðŸ·ï¸ Tagging images as prod-approved..."

                  # Pull and retag backend
                  docker pull registry.digitalocean.com/ai-incident-assistant/backend:$TAG
                  docker tag registry.digitalocean.com/ai-incident-assistant/backend:$TAG \
                             registry.digitalocean.com/ai-incident-assistant/backend:prod-approved-$TAG
                  docker push registry.digitalocean.com/ai-incident-assistant/backend:prod-approved-$TAG

                  # Pull and retag frontend
                  docker pull registry.digitalocean.com/ai-incident-assistant/frontend:$TAG
                  docker tag registry.digitalocean.com/ai-incident-assistant/frontend:$TAG \
                             registry.digitalocean.com/ai-incident-assistant/frontend:prod-approved-$TAG
                  docker push registry.digitalocean.com/ai-incident-assistant/frontend:prod-approved-$TAG

                  echo "âœ… Images tagged as prod-approved-$TAG"

            - name: Create approval metadata
              run: |
                  TAG="${{ steps.get-tag.outputs.tag }}"

                  mkdir -p artifacts
                  cat > artifacts/prod-approval.json <<EOF
                  {
                    "imageTag": "$TAG",
                    "approvedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                    "approvedBy": "staging-validation-workflow",
                    "stagingRunId": "${{ github.event.workflow_run.id }}",
                    "stagingRunUrl": "${{ github.event.workflow_run.html_url }}",
                    "approvalRunId": "${{ github.run_id }}",
                    "tests": {
                      "smoke": "passed",
                      "opa_policy": "passed",
                      "e2e": "passed",
                      "load": "passed"
                    },
                    "registry": {
                      "backend": "registry.digitalocean.com/ai-incident-assistant/backend:prod-approved-$TAG",
                      "frontend": "registry.digitalocean.com/ai-incident-assistant/frontend:prod-approved-$TAG"
                    },
                    "readyForProduction": true
                  }
                  EOF

                  echo "ðŸ“„ Approval metadata:"
                  cat artifacts/prod-approval.json

            - name: Upload approval artifact
              uses: actions/upload-artifact@v4
              with:
                  name: prod-approval-${{ steps.get-tag.outputs.tag }}
                  path: artifacts/prod-approval.json
                  retention-days: 90

            - name: Comment on commit
              uses: actions/github-script@v7
              with:
                  script: |
                      const tag = '${{ steps.get-tag.outputs.tag }}';
                      const runUrl = '${{ github.event.workflow_run.html_url }}';

                      try {
                          await github.rest.repos.createCommitComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              commit_sha: tag,
                              body: `## âœ… Production Approval\n\nThis build has **passed all staging validation tests** and is approved for production deployment.\n\n### ðŸ“¦ Approved Images\n\n- \`backend:prod-approved-${tag}\`\n- \`frontend:prod-approved-${tag}\`\n\n### âœ… Tests Passed\n\n- âœ… Smoke tests\n- âœ… OPA policy validation  \n- âœ… E2E tests (Playwright)\n- âœ… Load tests (k6)\n\n### ðŸš€ Next Steps\n\n1. Navigate to [Production Deployment Workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/production-deployment.yml)\n2. Click "Run workflow"\n3. Enter image tag: \`${tag}\`\n4. Review and approve the deployment PR\n\n**Staging Tests**: [View Results](${runUrl})`
                          });
                          console.log('âœ… Comment added to commit');
                      } catch (error) {
                          console.log('âš ï¸ Could not comment on commit:', error.message);
                      }

            - name: Create deployment summary
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                  ## âœ… Build Approved for Production

                  **Image Tag**: `${{ steps.get-tag.outputs.tag }}`

                  ### ðŸ·ï¸ Registry Tags

                  ```
                  backend:  registry.digitalocean.com/ai-incident-assistant/backend:prod-approved-${{ steps.get-tag.outputs.tag }}
                  frontend: registry.digitalocean.com/ai-incident-assistant/frontend:prod-approved-${{ steps.get-tag.outputs.tag }}
                  ```

                  ### âœ… Validation Results

                  | Test Type | Status |
                  |-----------|--------|
                  | Smoke Tests | âœ… Passed |
                  | OPA Policy | âœ… Passed |
                  | E2E Tests | âœ… Passed |
                  | Load Tests | âœ… Passed |

                  ### ðŸš€ Deploy to Production

                  This build is ready for production deployment. Use the [Production Deployment Workflow](https://github.com/${{ github.repository }}/actions/workflows/production-deployment.yml) to proceed.

                  **Staging Validation**: [View Results](${{ github.event.workflow_run.html_url }})

                  EOF

            - name: Send approval notification
              if: always()
              uses: slackapi/slack-github-action@v1
              with:
                  payload: |
                      {
                        "text": "âœ… Build Approved for Production",
                        "blocks": [
                          {
                            "type": "header",
                            "text": {
                              "type": "plain_text",
                              "text": "âœ… Build Approved for Production"
                            }
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "Image `${{ steps.get-tag.outputs.tag }}` has passed all staging validation tests and is ready for production deployment."
                            }
                          },
                          {
                            "type": "section",
                            "fields": [
                              {
                                "type": "mrkdwn",
                                "text": "*Smoke Tests:* âœ… Passed"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*OPA Policy:* âœ… Passed"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*E2E Tests:* âœ… Passed"
                              },
                              {
                                "type": "mrkdwn",
                                "text": "*Load Tests:* âœ… Passed"
                              }
                            ]
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*Registry Tags:*\nâ€¢ `backend:prod-approved-${{ steps.get-tag.outputs.tag }}`\nâ€¢ `frontend:prod-approved-${{ steps.get-tag.outputs.tag }}`"
                            }
                          },
                          {
                            "type": "actions",
                            "elements": [
                              {
                                "type": "button",
                                "text": {
                                  "type": "plain_text",
                                  "text": "Deploy to Production"
                                },
                                "url": "https://github.com/${{ github.repository }}/actions/workflows/production-deployment.yml"
                              },
                              {
                                "type": "button",
                                "text": {
                                  "type": "plain_text",
                                  "text": "View Tests"
                                },
                                "url": "${{ github.event.workflow_run.html_url }}"
                              }
                            ]
                          }
                        ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
