name: Test Network Connectivity

on:
    workflow_dispatch:

jobs:
    test-external-access:
        name: Test External Connectivity
        runs-on: ubuntu-latest

        steps:
            - name: Get GitHub runner IP
              run: |
                  echo "ğŸŒ GitHub Runner Public IP:"
                  curl -s https://api.ipify.org
                  echo ""

            - name: Test DNS resolution
              run: |
                  echo "ğŸ” DNS Resolution Test:"
                  nslookup staging.174.138.120.13.nip.io
                  dig staging.174.138.120.13.nip.io

            - name: Test ping
              run: |
                  echo "ğŸ“¡ Ping Test:"
                  ping -c 3 174.138.120.13 || echo "Ping failed (ICMP might be blocked)"

            - name: Test port 80 connectivity
              run: |
                  echo "ğŸ”Œ Port 80 Connectivity Test:"
                  timeout 10 bash -c 'cat < /dev/null > /dev/tcp/174.138.120.13/80' && echo "âœ… Port 80 is open" || echo "âŒ Port 80 is blocked"

            - name: Test HTTP with curl (verbose)
              run: |
                  echo "ğŸŒ HTTP Curl Test (verbose):"
                  curl -v --connect-timeout 10 --max-time 30 http://174.138.120.13/ || echo "Direct IP failed"

            - name: Test staging URL
              run: |
                  echo "ğŸ¯ Staging URL Test:"
                  curl -v --connect-timeout 10 --max-time 30 http://staging.174.138.120.13.nip.io/api || echo "Staging URL failed"

            - name: Test with different user agent
              run: |
                  echo "ğŸ¤– Test with different User-Agent:"
                  curl -v -H "User-Agent: Mozilla/5.0" --connect-timeout 10 http://staging.174.138.120.13.nip.io/api || echo "Failed with browser UA"

            - name: Test with wget
              run: |
                  echo "ğŸ“¥ Wget Test:"
                  wget --timeout=10 --tries=1 -O- http://staging.174.138.120.13.nip.io/api || echo "Wget failed"

            - name: Traceroute test
              run: |
                  echo "ğŸ—ºï¸ Traceroute to staging:"
                  traceroute -m 15 -w 2 174.138.120.13 || echo "Traceroute failed"
